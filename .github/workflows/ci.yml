name: CI Pipeline

# Wann soll die Pipeline laufen?
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# Was soll passieren?
jobs:
  build-and-test:
    name: Build & Test (PHP ${{ matrix.php-versions }})
    runs-on: ubuntu-latest

    # Wir testen gegen verschiedene PHP-Versionen (Matrix)
    strategy:
      fail-fast: false
      matrix:
        php-versions: ['8.2', '8.3']

    steps:
      # 1. Code auschecken
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. PHP Umgebung einrichten
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: mbstring, intl, pdo, pdo_sqlite
          coverage: xdebug # FIX: Coverage aktivieren (Tickets 0000043/0000072)

      # 3. Abhängigkeiten installieren
      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      # 4. Verzeichnisstruktur für Tests vorbereiten
      # (Falls wir File-Tests ohne vfsStream hätten, hier wichtig)
      - name: Prepare Filesystem
        run: |
          mkdir -p public/build
          mkdir -p public/pages
          touch config/modules.json

      # 5. Umgebungsvariablen für Tests setzen
      # Wir simulieren die .env Variablen direkt in der Pipeline
      - name: Create .env for Testing
        run: |
          echo "APP_ENV=test" >> .env
          echo "ADMIN_USER=admin" >> .env
          echo "ADMIN_EMAIL=admin@localhost" >> .env
          echo "ADMIN_PASSWORD_HASH='$argon2id$v=19$m=65536,t=4,p=1$NEF6R28u...' " >> .env

      # 7. Linting (PHP-CS-Fixer Dry Run) (Ticket 0000075)
      # Prüft Code-Style, bricht bei Verletzung ab.
      - name: Run PHP-CS-Fixer
        run: vendor/bin/php-cs-fixer fix --dry-run --diff --verbose

      # 8. Statische Analyse (PHPStan) (Ticket 0000075)
      # Prüft Code-Qualität und Typ-Konsistenz.
      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --error-format=github

      # 9. Tests ausführen & Coverage Report generieren (Tickets 0000074/0000072)
      # Führt Tests aus und generiert den Report zur späteren Auswertung.
      - name: Run PHPUnit with Coverage
        run: vendor/bin/phpunit --testdox --coverage-clover coverage.xml
        
      # 10. Upload Coverage Report (für GitHub UI/Artifacts)
      # Wird von Schritt 9 generiert.
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-report-${{ matrix.php-versions }}
          path: coverage.xml
          if-no-files-found: error # Stellt sicher, dass der Report generiert wurde

  # KORRIGIERT: Der neue Job muss direkt unter 'jobs:' stehen.
  release_and_deploy:
    name: Versioning & Deployment
    runs-on: ubuntu-latest
    needs: build-and-test
    # Läuft nur bei Push auf main/master (nicht bei PRs)
    if: success() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout Code (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Wichtig für Git-Operationen (Tagging)

      # 1. Versionierung: Automatisches Tagging (Ticket 0000044)
      - name: Create Version Tag (v0.8.14)
        run: |
          # Das manuelle Setzen der Version für den ersten Durchlauf.
          TAG_NAME="v0.8.14"
          git tag $TAG_NAME
          git push origin $TAG_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. Deployment Placeholder (Ticket 0000075)
      # FIX: Doppelpunkt im Namen durch Bindestrich ersetzt, um YAML-Fehler zu beheben.
      - name: CD Placeholder - Deploy Artifact
        run: |
          echo "Deployment der Version v0.8.14 zur Staging/Production Umgebung gestartet."
          echo "Dieser Schritt ist ein Placeholder für den eigentlichen CD-Prozess (z.B. SSH/SCP)."
          echo "Deployment Placeholder Complete."